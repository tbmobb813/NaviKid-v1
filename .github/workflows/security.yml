# ===================================================================
# Security Scanning Pipeline
# ===================================================================
# This workflow handles security scanning for the NaviKid project
#
# Triggers:
# - Push to any branch
# - Pull requests
# - Weekly scheduled scan (every Monday at 2 AM UTC)
# - Manual workflow dispatch
#
# Features:
# - Trivy vulnerability scanning for containers and dependencies
# - npm audit for JavaScript dependencies
# - SARIF report upload to GitHub Security tab
# - Scheduled weekly security audits
# ===================================================================

name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run every Monday at 2:00 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      scan_level:
        description: 'Scan severity level'
        required: false
        default: 'CRITICAL,HIGH'
        type: choice
        options:
          - 'CRITICAL'
          - 'CRITICAL,HIGH'
          - 'CRITICAL,HIGH,MEDIUM'
          - 'ALL'

permissions:
  contents: read
  security-events: write
  actions: read

env:
  NODE_VERSION: '18.x'

jobs:
  # ===================================================================
  # DEPENDENCY SCANNING - FRONTEND
  # ===================================================================
  scan-frontend-dependencies:
    name: Scan Frontend Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run npm audit
        run: |
          echo "üîí Running npm audit on frontend dependencies..."
          npm audit --json > frontend-audit.json || true
          npm audit --audit-level=moderate || echo "Vulnerabilities detected"
        continue-on-error: true

      - name: Parse audit results
        run: |
          if [ -f frontend-audit.json ]; then
            echo "üìä Frontend Audit Results:"
            cat frontend-audit.json | jq '.metadata' || echo "Unable to parse audit results"

            # Extract vulnerability counts
            CRITICAL=$(cat frontend-audit.json | jq '.metadata.vulnerabilities.critical // 0')
            HIGH=$(cat frontend-audit.json | jq '.metadata.vulnerabilities.high // 0')
            MODERATE=$(cat frontend-audit.json | jq '.metadata.vulnerabilities.moderate // 0')

            echo "Critical: $CRITICAL"
            echo "High: $HIGH"
            echo "Moderate: $MODERATE"

            # Fail if critical vulnerabilities found
            if [ "$CRITICAL" -gt 0 ]; then
              echo "‚ùå Critical vulnerabilities found!"
              exit 1
            fi
          fi
        continue-on-error: true

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-audit-report
          path: frontend-audit.json
          if-no-files-found: ignore

  # ===================================================================
  # DEPENDENCY SCANNING - BACKEND
  # ===================================================================
  scan-backend-dependencies:
    name: Scan Backend Dependencies
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run npm audit
        run: |
          echo "üîí Running npm audit on backend dependencies..."
          npm audit --json > backend-audit.json || true
          npm audit --audit-level=moderate || echo "Vulnerabilities detected"
        continue-on-error: true

      - name: Parse audit results
        run: |
          if [ -f backend-audit.json ]; then
            echo "üìä Backend Audit Results:"
            cat backend-audit.json | jq '.metadata' || echo "Unable to parse audit results"

            # Extract vulnerability counts
            CRITICAL=$(cat backend-audit.json | jq '.metadata.vulnerabilities.critical // 0')
            HIGH=$(cat backend-audit.json | jq '.metadata.vulnerabilities.high // 0')
            MODERATE=$(cat backend-audit.json | jq '.metadata.vulnerabilities.moderate // 0')

            echo "Critical: $CRITICAL"
            echo "High: $HIGH"
            echo "Moderate: $MODERATE"

            # Fail if critical vulnerabilities found
            if [ "$CRITICAL" -gt 0 ]; then
              echo "‚ùå Critical vulnerabilities found!"
              exit 1
            fi
          fi
        continue-on-error: true

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-audit-report
          path: backend/backend-audit.json
          if-no-files-found: ignore

  # ===================================================================
  # TRIVY FILESYSTEM SCAN
  # ===================================================================
  trivy-fs-scan:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (Filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: ${{ github.event.inputs.scan_level || 'CRITICAL,HIGH' }}
          ignore-unfixed: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-filesystem'

      - name: Generate human-readable report
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          output: 'trivy-report.txt'
          severity: ${{ github.event.inputs.scan_level || 'CRITICAL,HIGH' }}

      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-filesystem-report
          path: |
            trivy-results.sarif
            trivy-report.txt
          if-no-files-found: ignore

  # ===================================================================
  # TRIVY CONFIGURATION SCAN
  # ===================================================================
  trivy-config-scan:
    name: Trivy Configuration Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy configuration scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-config-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          skip-dirs: 'node_modules,dist,build'

      - name: Upload config scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-config-results.sarif'
          category: 'trivy-config'

      - name: Generate config report
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          output: 'trivy-config-report.txt'
          severity: 'CRITICAL,HIGH,MEDIUM'
          skip-dirs: 'node_modules,dist,build'

      - name: Upload configuration report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-config-report
          path: |
            trivy-config-results.sarif
            trivy-config-report.txt
          if-no-files-found: ignore

  # ===================================================================
  # SECRET SCANNING
  # ===================================================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for hardcoded secrets
        run: |
          echo "üîê Scanning for hardcoded secrets..."

          # Check for common secret patterns
          echo "Checking for API keys..."
          ! grep -rE "(api_key|apikey|api-key)\s*[:=]\s*['\"][a-zA-Z0-9]{20,}['\"]" . \
            --exclude-dir={node_modules,dist,build,.git} || echo "‚ö†Ô∏è  Potential API keys found"

          echo "Checking for passwords..."
          ! grep -rE "password\s*[:=]\s*['\"][^'\"]{8,}['\"]" . \
            --exclude-dir={node_modules,dist,build,.git} || echo "‚ö†Ô∏è  Potential passwords found"

          echo "Checking for tokens..."
          ! grep -rE "(token|auth_token)\s*[:=]\s*['\"][a-zA-Z0-9]{20,}['\"]" . \
            --exclude-dir={node_modules,dist,build,.git} || echo "‚ö†Ô∏è  Potential tokens found"

          echo "‚úÖ Secret scan completed"
        continue-on-error: true

      - name: Verify .env files are gitignored
        run: |
          echo "üîç Verifying sensitive files are gitignored..."

          # Check if .env files exist in git
          if git ls-files | grep -E "\.env$|\.env\.local$|\.env\.production$"; then
            echo "‚ùå .env files found in git!"
            exit 1
          else
            echo "‚úÖ No .env files in git"
          fi
        continue-on-error: true

      - name: Check for AWS credentials
        run: |
          echo "‚òÅÔ∏è  Checking for AWS credentials..."
          ! grep -rE "AKIA[0-9A-Z]{16}" . \
            --exclude-dir={node_modules,dist,build,.git} || echo "‚ö†Ô∏è  Potential AWS keys found"
        continue-on-error: true

  # ===================================================================
  # DOCKER IMAGE SCAN (if Docker is used)
  # ===================================================================
  trivy-docker-scan:
    name: Trivy Docker Image Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Dockerfile
        id: check_dockerfile
        run: |
          if [ -f "Dockerfile" ] || [ -f "backend/Dockerfile" ]; then
            echo "dockerfile_exists=true" >> $GITHUB_OUTPUT
          else
            echo "dockerfile_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Docker image
        if: steps.check_dockerfile.outputs.dockerfile_exists == 'true'
        run: |
          if [ -f "Dockerfile" ]; then
            docker build -t navikid:latest .
          elif [ -f "backend/Dockerfile" ]; then
            docker build -t navikid-backend:latest ./backend
          fi
        continue-on-error: true

      - name: Run Trivy scanner on Docker image
        if: steps.check_dockerfile.outputs.dockerfile_exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'navikid:latest'
          format: 'sarif'
          output: 'trivy-docker-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Upload Docker scan results
        if: steps.check_dockerfile.outputs.dockerfile_exists == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-docker-results.sarif'
          category: 'trivy-docker'
        continue-on-error: true

  # ===================================================================
  # SECURITY SUMMARY
  # ===================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs:
      - scan-frontend-dependencies
      - scan-backend-dependencies
      - trivy-fs-scan
      - trivy-config-scan
      - secret-scan
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-reports/
        continue-on-error: true

      - name: Generate security summary
        run: |
          echo "## üîí Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Dependencies | ${{ needs.scan-frontend-dependencies.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Dependencies | ${{ needs.scan-backend-dependencies.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy Filesystem | ${{ needs.trivy-fs-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy Configuration | ${{ needs.trivy-config-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.scan-frontend-dependencies.result }}" != "success" ] || \
             [ "${{ needs.scan-backend-dependencies.result }}" != "success" ]; then
            echo "‚ö†Ô∏è  **Action Required:** Review security vulnerabilities" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ All security scans passed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for critical failures
        run: |
          echo "üìä Security Pipeline Results"
          echo "=============================="
          echo "Frontend Dependencies: ${{ needs.scan-frontend-dependencies.result }}"
          echo "Backend Dependencies: ${{ needs.scan-backend-dependencies.result }}"
          echo "Trivy Filesystem: ${{ needs.trivy-fs-scan.result }}"
          echo "Trivy Configuration: ${{ needs.trivy-config-scan.result }}"
          echo "Secret Scanning: ${{ needs.secret-scan.result }}"
          echo "=============================="

          # Don't fail the pipeline, just warn
          if [ "${{ needs.scan-frontend-dependencies.result }}" == "failure" ] || \
             [ "${{ needs.scan-backend-dependencies.result }}" == "failure" ]; then
            echo "‚ö†Ô∏è  Security issues detected - please review"
          else
            echo "‚úÖ No critical security issues detected"
          fi
