name: Parental Linker Check

on:
  push:
    branches: [ main ]
  pull_request:
    paths:
      - '**/*.ts'
      - '.test-debug/**'

jobs:
  linker-check:
    name: Run instrumented test + linker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run focused instrumented Jest (produce .test-debug/instrumented-events.log)
        id: run-tests
        run: |
          set -euo pipefail
          JEST_EXIT=0
          # run the focused test; capture non-zero exit but continue so we can always produce the linker report
          BABEL_DISABLE_MODULE_RESOLVER=1 npx jest __tests__/parental-auth-security.test.ts --runInBand --setupFiles=./.test-debug/jest-log-timestamps.cjs --setupFiles=./.test-debug/logger-wrap.cjs --detectOpenHandles --verbose || JEST_EXIT=$?
          echo "jest_exit=$JEST_EXIT" >> $GITHUB_OUTPUT

      - name: Run linker and create JSON report
        run: |
          node .test-debug/link_active_ops_to_auth.cjs .test-debug/instrumented-events.log .test-debug/link_report.json json

      - name: Assert no decrements when isMounted==false
        run: |
          set -euo pipefail
          COUNT=$(jq '[.instances[].auths[]? | select(.auth != null and (.isMounted == false) and ((.decrements|length) > 0))] | length' .test-debug/link_report.json)
          if [ "$COUNT" -gt 0 ]; then
            echo "Found $COUNT auth buckets with decrements while isMounted==false"
            jq '.instances[] | select(.auths[]? | .auth != null and (.isMounted == false) and ((.decrements|length) > 0))' .test-debug/link_report.json
            exit 1
          fi

      - name: Upload linker report
        uses: actions/upload-artifact@v4
        with:
          name: parental-link-report
          path: .test-debug/link_report.json

      - name: Fail if Jest failed
        if: always()
        run: |
          set -euo pipefail
          if [ -n "${{ steps.run-tests.outputs.jest_exit }}" ] && [ "${{ steps.run-tests.outputs.jest_exit }}" != "0" ]; then
            echo "Jest tests failed (exit ${{ steps.run-tests.outputs.jest_exit }})"
            exit ${{ steps.run-tests.outputs.jest_exit }}
          fi
