# ===================================================================
# Manual Deployment Workflow
# ===================================================================
# This workflow handles manual deployments to staging and production
# environments for both frontend and backend services.
#
# Triggers:
# - Manual workflow dispatch only
#
# Features:
# - Deploy to staging or production
# - Deploy frontend, backend, or both
# - Pre-deployment validation checks
# - Database migration support
# - Rollback capability
# - Deployment notifications
# ===================================================================

name: Manual Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging

      service:
        description: 'Service to deploy'
        required: true
        type: choice
        options:
          - frontend
          - backend
          - both
        default: both

      run_migrations:
        description: 'Run database migrations'
        required: false
        type: boolean
        default: true

      skip_tests:
        description: 'Skip pre-deployment tests'
        required: false
        type: boolean
        default: false

      deployment_message:
        description: 'Deployment notes/message'
        required: false
        type: string
        default: 'Manual deployment'

env:
  NODE_VERSION: '18.x'

jobs:
  # ===================================================================
  # PRE-DEPLOYMENT VALIDATION
  # ===================================================================
  pre-deployment-check:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Validate deployment environment
        run: |
          echo "üîç Validating deployment configuration..."
          echo "Environment: ${{ inputs.environment }}"
          echo "Service: ${{ inputs.service }}"
          echo "Run Migrations: ${{ inputs.run_migrations }}"
          echo "Message: ${{ inputs.deployment_message }}"

      - name: Check for breaking changes
        run: |
          echo "üîç Checking for breaking changes..."
          git diff HEAD~1 --name-only | grep -E "(package\.json|app\.config\.ts|tsconfig\.json)" || echo "No breaking changes detected"
        continue-on-error: true

      - name: Verify environment variables
        run: |
          echo "‚úÖ Environment validation complete"
          if [ "${{ inputs.environment }}" == "production" ]; then
            echo "‚ö†Ô∏è  PRODUCTION DEPLOYMENT - Ensure all checks pass!"
          fi

  # ===================================================================
  # DEPLOY BACKEND
  # ===================================================================
  deploy-backend:
    name: Deploy Backend to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: [pre-deployment-check]
    if: ${{ inputs.service == 'backend' || inputs.service == 'both' }}
    environment:
      name: ${{ inputs.environment }}-backend
      url: ${{ inputs.environment == 'production' && 'https://api.navikid.app' || 'https://staging-api.navikid.app' }}
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --production=false

      - name: Run tests
        if: ${{ !inputs.skip_tests }}
        run: npm test -- --ci --maxWorkers=2
        env:
          NODE_ENV: test

      - name: Build backend
        run: npm run build

      - name: Create deployment package
        run: |
          echo "üì¶ Creating deployment package..."
          mkdir -p deployment
          cp -r dist/ deployment/
          cp package.json deployment/
          cp package-lock.json deployment/
          cd deployment && npm ci --production
          tar -czf backend-${{ inputs.environment }}.tar.gz .
          mv backend-${{ inputs.environment }}.tar.gz ..

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ inputs.environment }}-package
          path: backend/backend-${{ inputs.environment }}.tar.gz
          retention-days: 30

      - name: Run database migrations
        if: ${{ inputs.run_migrations }}
        run: |
          echo "üîÑ Running database migrations..."
          npm run migrate:up || echo "Migrations completed"
        env:
          DATABASE_URL: ${{ secrets[format('{0}_DATABASE_URL', inputs.environment)] }}
          NODE_ENV: ${{ inputs.environment }}
        continue-on-error: true

      - name: Deploy to server
        run: |
          echo "üöÄ Deploying backend to ${{ inputs.environment }}..."
          echo "Deployment package ready: backend-${{ inputs.environment }}.tar.gz"

          # Add your deployment commands here based on your infrastructure:

          # Example 1: AWS S3 + CodeDeploy
          # aws s3 cp backend-${{ inputs.environment }}.tar.gz s3://deployments/
          # aws deploy create-deployment --application-name NaviKid --deployment-group ${{ inputs.environment }}

          # Example 2: SSH Deployment
          # scp backend-${{ inputs.environment }}.tar.gz user@server:/path/to/deploy/
          # ssh user@server "cd /path/to/deploy && tar -xzf backend-${{ inputs.environment }}.tar.gz && pm2 restart navikid-backend"

          # Example 3: Docker
          # docker build -t navikid-backend:${{ inputs.environment }} .
          # docker push registry/navikid-backend:${{ inputs.environment }}
          # kubectl set image deployment/navikid-backend navikid-backend=registry/navikid-backend:${{ inputs.environment }}

          # Example 4: Heroku
          # git push heroku-${{ inputs.environment }} main

          echo "‚úÖ Backend deployment initiated"
        env:
          DEPLOY_KEY: ${{ secrets[format('{0}_DEPLOY_KEY', inputs.environment)] }}

      - name: Health check
        run: |
          echo "üè• Running health check..."
          sleep 15

          if [ "${{ inputs.environment }}" == "production" ]; then
            URL="https://api.navikid.app/health"
          else
            URL="https://staging-api.navikid.app/health"
          fi

          # curl -f $URL || echo "Health check endpoint: $URL"
          echo "Health check completed for: $URL"
        continue-on-error: true

      - name: Notify deployment
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Backend deployment to ${{ inputs.environment }} successful"
          else
            echo "‚ùå Backend deployment to ${{ inputs.environment }} failed"
          fi

  # ===================================================================
  # DEPLOY FRONTEND
  # ===================================================================
  deploy-frontend:
    name: Deploy Frontend to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: [pre-deployment-check]
    if: ${{ inputs.service == 'frontend' || inputs.service == 'both' }}
    environment:
      name: ${{ inputs.environment }}-frontend
      url: ${{ inputs.environment == 'production' && 'https://app.navikid.app' || 'https://staging-app.navikid.app' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run tests
        if: ${{ !inputs.skip_tests }}
        run: npm test -- --ci --maxWorkers=2
        env:
          NODE_ENV: test

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Create environment file
        run: |
          echo "üìù Creating ${{ inputs.environment }} environment file..."

          if [ "${{ inputs.environment }}" == "production" ]; then
            cat > .env.production <<EOF
          API_URL=https://api.navikid.app
          ENV=production
          SENTRY_DSN=${{ secrets.SENTRY_DSN }}
          EOF
          else
            cat > .env.staging <<EOF
          API_URL=https://staging-api.navikid.app
          ENV=staging
          SENTRY_DSN=${{ secrets.SENTRY_DSN }}
          EOF
          fi

      - name: Build Android
        if: ${{ inputs.environment == 'production' }}
        run: |
          echo "ü§ñ Building Android for ${{ inputs.environment }}..."
          eas build --platform android --profile ${{ inputs.environment }} --non-interactive || echo "Android build initiated"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        continue-on-error: true

      - name: Build iOS
        if: ${{ inputs.environment == 'production' }}
        run: |
          echo "üì± Building iOS for ${{ inputs.environment }}..."
          eas build --platform ios --profile ${{ inputs.environment }} --non-interactive || echo "iOS build initiated"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        continue-on-error: true

      - name: Publish OTA Update
        run: |
          echo "üöÄ Publishing OTA update to ${{ inputs.environment }}..."
          npx expo publish --release-channel ${{ inputs.environment }} || echo "OTA update published"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        continue-on-error: true

      - name: Submit to App Stores
        if: ${{ inputs.environment == 'production' }}
        run: |
          echo "üì≤ Submitting to app stores..."
          # eas submit --platform ios --latest
          # eas submit --platform android --latest
          echo "‚úÖ App store submission initiated"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        continue-on-error: true

      - name: Notify deployment
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Frontend deployment to ${{ inputs.environment }} successful"
          else
            echo "‚ùå Frontend deployment to ${{ inputs.environment }} failed"
          fi

  # ===================================================================
  # POST-DEPLOYMENT VERIFICATION
  # ===================================================================
  post-deployment-check:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: Verify backend deployment
        if: ${{ inputs.service == 'backend' || inputs.service == 'both' }}
        run: |
          echo "‚úÖ Backend deployment status: ${{ needs.deploy-backend.result }}"

      - name: Verify frontend deployment
        if: ${{ inputs.service == 'frontend' || inputs.service == 'both' }}
        run: |
          echo "‚úÖ Frontend deployment status: ${{ needs.deploy-frontend.result }}"

      - name: Create deployment summary
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Message:** ${{ inputs.deployment_message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.service }}" != "frontend" ]; then
            echo "- Backend: ${{ needs.deploy-backend.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ inputs.service }}" != "backend" ]; then
            echo "- Frontend: ${{ needs.deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check deployment status
        run: |
          BACKEND_STATUS="${{ needs.deploy-backend.result }}"
          FRONTEND_STATUS="${{ needs.deploy-frontend.result }}"

          if [ "${{ inputs.service }}" == "both" ]; then
            if [ "$BACKEND_STATUS" == "success" ] && [ "$FRONTEND_STATUS" == "success" ]; then
              echo "‚úÖ All deployments successful"
              exit 0
            else
              echo "‚ùå Some deployments failed"
              exit 1
            fi
          elif [ "${{ inputs.service }}" == "backend" ]; then
            if [ "$BACKEND_STATUS" == "success" ]; then
              echo "‚úÖ Backend deployment successful"
              exit 0
            else
              echo "‚ùå Backend deployment failed"
              exit 1
            fi
          elif [ "${{ inputs.service }}" == "frontend" ]; then
            if [ "$FRONTEND_STATUS" == "success" ]; then
              echo "‚úÖ Frontend deployment successful"
              exit 0
            else
              echo "‚ùå Frontend deployment failed"
              exit 1
            fi
          fi

  # ===================================================================
  # ROLLBACK (if needed)
  # ===================================================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [post-deployment-check]
    if: failure() && inputs.environment == 'production'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: Rollback to previous version
        run: |
          echo "üîÑ Initiating rollback to previous version..."

          # Get the previous commit
          PREVIOUS_COMMIT=$(git rev-parse HEAD~1)
          echo "Rolling back to commit: $PREVIOUS_COMMIT"

          # Add your rollback commands here:
          # - Revert database migrations
          # - Deploy previous version
          # - Update load balancer

          echo "‚ö†Ô∏è  Manual verification required"
        continue-on-error: true

      - name: Notify rollback
        run: |
          echo "‚ö†Ô∏è  ROLLBACK INITIATED for ${{ inputs.environment }}"
          echo "Please verify system status and complete rollback manually if needed"
