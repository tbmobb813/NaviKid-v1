# GitHub Copilot Instructions for NaviKid

## Project Overview

NaviKid is a React Native/Expo navigation app that teaches children aged 8-12 navigation skills while empowering them with safe, age-appropriate tools. This is **not** a tracking app—it's an educational platform focused on building independence and confidence.

**Key Principle**: Educational value and child empowerment over passive tracking.

## Tech Stack

### Frontend
- **Framework**: React Native with Expo (SDK 52+)
- **Routing**: Expo Router (file-based routing in `app/` directory)
- **Language**: TypeScript (strict mode)
- **Styling**: NativeWind (Tailwind CSS for React Native)
- **State Management**: Zustand for client state, TanStack React Query for server state
- **Storage**: AsyncStorage for local persistence
- **Maps**: MapLibre GL with OpenStreetMap data
- **Routing**: Openrouteservice (ORS) API

### Backend
- **Runtime**: Node.js 18+
- **Framework**: Fastify
- **Language**: TypeScript
- **Database**: PostgreSQL 14+ with PostGIS extension
- **Cache**: Redis 6+
- **Authentication**: JWT (access + refresh tokens)
- **Validation**: Zod schemas
- **Logging**: Pino
- **Monitoring**: Sentry

## Project Structure

```
navikid/
├── app/                    # Expo Router screens (file-based routing)
├── components/             # Reusable React components
├── stores/                 # Zustand state stores
├── services/               # API clients, WebSocket, offline queue
├── utils/                  # Utility functions and helpers
├── types/                  # TypeScript type definitions
├── backend/                # Node.js/Fastify backend
│   ├── src/
│   │   ├── routes/        # API endpoints
│   │   ├── services/      # Business logic
│   │   ├── middleware/    # Request middleware
│   │   └── utils/         # Backend utilities
│   └── migrations/        # Database migrations
├── docs/                   # Comprehensive documentation
└── scripts/               # Build and deployment scripts
```

## Code Style & Conventions

### TypeScript
- **Strict mode**: Always enabled, no `any` without justification
- **Type imports**: Use `import type` for type-only imports
- **Naming**: 
  - PascalCase for components and types
  - camelCase for functions and variables
  - UPPER_SNAKE_CASE for constants
- **Exports**: Prefer named exports over default exports (except for React components)

### React Native Components
```typescript
// Good component pattern
import { View, Text } from 'react-native';
import type { PropsWithChildren } from 'react';

interface MyComponentProps {
  title: string;
  onPress?: () => void;
}

export function MyComponent({ title, onPress, children }: PropsWithChildren<MyComponentProps>) {
  return (
    <View className="p-4 bg-white">
      <Text className="text-lg font-bold">{title}</Text>
      {children}
    </View>
  );
}
```

### Zustand Store Pattern
```typescript
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import AsyncStorage from '@react-native-async-storage/async-storage';

interface MyStore {
  value: string;
  setValue: (value: string) => void;
  reset: () => void;
}

const initialState = {
  value: '',
};

export const useMyStore = create<MyStore>()(
  persist(
    (set) => ({
      ...initialState,
      setValue: (value) => set({ value }),
      reset: () => set(initialState),
    }),
    {
      name: 'my-store',
      storage: createJSONStorage(() => AsyncStorage),
    }
  )
);
```

### API Service Pattern
```typescript
import apiClient from '@/services/api';

// Use the centralized API client
const result = await apiClient.auth.login(email, password);
if (result.success) {
  // Handle success
} else {
  // Handle error: result.error
}
```

### Styling with NativeWind
```typescript
// Use Tailwind utility classes
<View className="flex-1 justify-center items-center bg-blue-500 p-4">
  <Text className="text-white text-xl font-bold">Hello</Text>
</View>
```

## Critical Security Requirements

### COPPA Compliance
- **No data collection** without verifiable parental consent
- **Data retention**: Location data max 30 days, search history 90 days
- **Privacy by design**: Local-first storage, minimal cloud sync
- **Parental controls**: PIN-protected settings and data access

### Input Validation
```typescript
// Always validate user inputs
import { validateEmail, validatePassword } from '@/utils/validation';

if (!validateEmail(email)) {
  showError('Invalid email format');
  return;
}

if (!validatePassword(password)) {
  showError('Password must be 8+ characters with uppercase, lowercase, and number');
  return;
}
```

### Authentication
```typescript
// Never bypass authentication checks
import { useAuthStore } from '@/stores/authStore';

const { isAuthenticated, user } = useAuthStore();

if (!isAuthenticated) {
  router.replace('/login');
  return;
}
```

## Testing Requirements

### Unit Tests
- Use Jest + React Native Testing Library
- Place tests in `__tests__/` directory
- Target 70%+ coverage for new code
- Mock external dependencies (AsyncStorage, API calls, location services)

```typescript
// Test pattern
import { render, fireEvent, waitFor } from '@testing-library/react-native';
import { MyComponent } from '@/components/MyComponent';

describe('MyComponent', () => {
  it('renders correctly', () => {
    const { getByText } = render(<MyComponent title="Test" />);
    expect(getByText('Test')).toBeTruthy();
  });

  it('handles press events', async () => {
    const onPress = jest.fn();
    const { getByText } = render(
      <MyComponent title="Test" onPress={onPress} />
    );
    
    fireEvent.press(getByText('Test'));
    await waitFor(() => expect(onPress).toHaveBeenCalled());
  });
});
```

## Common Patterns

### Async Operations
```typescript
// Use React Query for server state
import { useQuery, useMutation } from '@tanstack/react-query';

const { data, isLoading, error } = useQuery({
  queryKey: ['locations'],
  queryFn: () => apiClient.locations.getHistory(),
});

const mutation = useMutation({
  mutationFn: (location) => apiClient.locations.sendLocation(location),
  onSuccess: () => {
    // Invalidate and refetch
  },
});
```

### Error Handling
```typescript
// Consistent error handling pattern
try {
  const result = await apiClient.someOperation();
  if (!result.success) {
    showError(result.error || 'Operation failed');
    return;
  }
  // Handle success
} catch (error) {
  console.error('Unexpected error:', error);
  showError('An unexpected error occurred');
}
```

### Offline Support
```typescript
// Use offline queue for actions when offline
import { offlineQueue } from '@/services/offlineQueue';

if (!isOnline) {
  await offlineQueue.addAction('location_update', locationData);
  return;
}

await apiClient.locations.sendLocation(locationData);
```

## File Organization

### Components
- One component per file
- Co-locate component-specific types
- Keep components small and focused (<200 lines)
- Extract complex logic to custom hooks

### Stores
- One store per domain (auth, location, safeZones, etc.)
- Keep stores focused on specific concerns
- Use middleware for persistence and dev tools

### Services
- Centralized API client in `services/api.ts`
- Separate concerns (auth, locations, safeZones, etc.)
- Handle retries and error mapping
- Return consistent result objects

## Environment Variables

```typescript
// Access environment variables
import Constants from 'expo-constants';

const apiUrl = Constants.expoConfig?.extra?.apiUrl || 'http://localhost:3000';
const orsApiKey = Constants.expoConfig?.extra?.orsApiKey;

// Frontend (.env)
EXPO_PUBLIC_API_URL=http://localhost:3000
EXPO_PUBLIC_ORS_API_KEY=your_key_here

// Backend (backend/.env)
DATABASE_URL=postgresql://user:pass@localhost:5432/navikid
REDIS_URL=redis://localhost:6379
JWT_SECRET=your_secret_here
```

## Performance Considerations

### React Native
- Use `React.memo` for expensive components
- Implement `useMemo` and `useCallback` for expensive computations
- Lazy load large components and routes
- Optimize FlatList with `getItemLayout` and proper `keyExtractor`

### Networking
- Batch API requests when possible
- Implement request caching with React Query
- Use WebSocket for real-time updates (avoid polling)
- Implement exponential backoff for retries

### Storage
- Minimize AsyncStorage reads/writes
- Batch storage operations
- Use Zustand persistence selectively (only for needed state)
- Implement data retention cleanup

## Integration Points

### MapLibre
```typescript
import MapLibreGL from '@maplibre/maplibre-react-native';

<MapLibreGL.MapView
  style={{ flex: 1 }}
  styleURL="https://demotiles.maplibre.org/style.json"
>
  <MapLibreGL.Camera
    zoomLevel={13}
    centerCoordinate={[longitude, latitude]}
  />
</MapLibreGL.MapView>
```

### Location Services
```typescript
import * as Location from 'expo-location';

const { status } = await Location.requestForegroundPermissionsAsync();
const location = await Location.getCurrentPositionAsync({
  accuracy: Location.Accuracy.High,
});
```

## Documentation

- Add JSDoc comments for public APIs
- Document complex algorithms and business logic
- Keep README files updated
- Use TypeScript types as documentation where possible

## Deployment

### Development
```bash
npx expo start              # Start dev server
npm test                    # Run tests
npm run typecheck           # TypeScript check
npm run lint               # ESLint
```

### Production
```bash
# Build for production
eas build --profile production --platform all

# Deploy backend
./scripts/deploy-backend.sh production
```

## Key Dependencies

- `expo` - Expo framework
- `expo-router` - File-based routing
- `zustand` - State management
- `@tanstack/react-query` - Server state management
- `nativewind` - Tailwind CSS for React Native
- `@maplibre/maplibre-react-native` - Maps
- `@react-native-async-storage/async-storage` - Local storage
- `expo-location` - Location services
- `zod` - Runtime validation

## Avoid

- ❌ Using `var` (use `const` or `let`)
- ❌ Using `any` type without strong justification
- ❌ Storing sensitive data unencrypted
- ❌ Bypassing parental controls or authentication
- ❌ Creating memory leaks with unsubscribed listeners
- ❌ Hardcoding API URLs or secrets
- ❌ Using deprecated React Native APIs
- ❌ Collecting child data without consent

## Questions to Ask Before Coding

1. Does this respect child privacy and COPPA requirements?
2. Is this properly typed with TypeScript?
3. Have I validated all user inputs?
4. Will this work offline if needed?
5. Is this testable?
6. Does this follow existing patterns?
7. Is error handling comprehensive?
8. Will this perform well on older devices?

## Additional Resources

- [Expo Documentation](https://docs.expo.dev)
- [React Native Documentation](https://reactnative.dev)
- [MapLibre GL JS Documentation](https://maplibre.org/maplibre-gl-js-docs/api/)
- [Project Documentation](./docs/INDEX.md)
- [Quick Start Guide](./QUICKSTART.md)
- [API Documentation](./backend/API_DOCUMENTATION.md)
